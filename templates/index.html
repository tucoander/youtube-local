<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>Busca YouTube com React</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- CSS externo -->
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="/static/sidebar.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous" />

  <style>
    body {
      font-family: "Roboto", Arial, sans-serif;
      padding: 2rem;
    }

    input {
      padding: 0.5rem;
      width: 300px;
      margin-right: 1rem;
    }

    button {
      padding: 0.5rem 1rem;
    }

    .results {
      margin-top: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  {% include '_sidebar.html' %}
  <!-- ... (mesmo <head> e estilos anteriores) ... -->
  {% raw %}
  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [query, setQuery] = useState("");
      const [videos, setVideos] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [apiKey, setApiKey] = useState(null);

      // Carrega a chave da API do arquivo externo
      useEffect(() => {
        fetch("/static/youtube-api.key")
          .then((res) => res.text())
          .then((key) => setApiKey(key.trim()))
          .catch(() => setError("Erro ao carregar a chave da API."));
      }, []);

      const handleSearch = async () => {
        if (!query.trim() || !apiKey) return;
        setLoading(true);
        setError(null);
        setVideos([]);

        try {
          // 1. Buscar vÃ­deos com search
          const response = await fetch(
            `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(
              query
            )}&type=video&maxResults=12&key=${apiKey}`
          );
          const data = await response.json();

          if (data.items && data.items.length > 0) {
            // 2. Extrair IDs dos vÃ­deos
            const ids = data.items.map((item) => item.id.videoId).join(",");

            // 3. Buscar detalhes com videos
            const detailsResponse = await fetch(
              `https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${ids}&key=${apiKey}`
            );
            const detailsData = await detailsResponse.json();

            // 4. Formatar duraÃ§Ã£o
            const formatDuration = (iso) => {
              const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
              const h = match[1] ? `${match[1]}:` : "";
              const m = match[2] ? match[2].padStart(2, "0") : "00";
              const s = match[3] ? match[3].padStart(2, "0") : "00";
              return `${h}${m}:${s}`;
            };

            // 5. Montar resultados finais
            const results = detailsData.items.map((item) => ({
              id: item.id,
              title: item.snippet.title,
              thumbnail: item.snippet.thumbnails.medium.url,
              publishedAt: item.snippet.publishedAt,
              duration: formatDuration(item.contentDetails.duration),
            }));

            setVideos(results);
          } else {
            setError("Nenhum vÃ­deo encontrado.");
          }
        } catch (err) {
          setError("Erro ao buscar vÃ­deos.");
        } finally {
          setLoading(false);
        }
      };

      return (
        <div>
          <h1>ðŸ”Ž Buscar vÃ­deos no YouTube</h1>
          <input
            type="text"
            placeholder="Digite sua busca..."
            value={query}
            onChange={(e) => setQuery(e.target.value)}
          />
          <button onClick={handleSearch} disabled={!apiKey}>
            Buscar
          </button>

          {loading && <p>Carregando...</p>}
          {error && <p style={{ color: "red" }}>{error}</p>}

          <div className="results">
            {videos.map((video) => (
              <div key={video.id} className="video-card">
                <div className="thumbnail-container">
                  <img src={video.thumbnail} alt={video.title} />
                  <span className="duration">{video.duration}</span>
                </div>
                <div className="video-info">
                  <h4>{video.title}</h4>
                  <p className="meta">
                    ðŸ“…{" "}
                    {new Date(video.publishedAt).toLocaleDateString("pt-BR")}
                  </p>
                </div>
                <div
                  className="download-footer"
                  onClick={() => {
                    const url = `https://www.youtube.com/watch?v=${video.id}`;
                    window.open(
                      `http://localhost:5000/aguardando?url=${encodeURIComponent(
                        url
                      )}`,
                      "_blank"
                    );
                  }}
                >
                  ðŸ“¥ Baixar e assistir
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
  {% endraw %}
</body>

</html>